import psycopg2
from pathlib import Path

def main():

    project_folder = Path("/home/ubuntu/Songbook")
    _key_file = project_folder / "key-file.txt"

    with _key_file.open() as key_file:
        input_list = key_file.readlines()

    password = input_list[0]
    login_info = "dbname='postgres' user='postgres' host='localhost' password='{}'".format(password)

    SQL = """
    CREATE TABLE TimePeriods (
        TimePeriodID INT GENERATED BY DEFAULT AS IDENTITY,
        TimePeriodName VARCHAR(50) UNIQUE NOT NULL,
        PRIMARY KEY (TimePeriodID)
    );

    CREATE TABLE Genres (
        GenreID SMALLINT GENERATED BY DEFAULT AS IDENTITY,
        GenreName VARCHAR(50) UNIQUE NOT NULL,
        PRIMARY KEY(GenreID)
    );

    CREATE TABLE Modes(
        ModeID SMALLINT GENERATED BY DEFAULT AS IDENTITY,
        ModeName VARCHAR(50) UNIQUE NOT NULL,
        PRIMARY KEY (ModeID)
    );

    CREATE TABLE AbsoluteNotes(
        AbsoluteNoteID SMALLINT,
        PRIMARY KEY (AbsoluteNoteID)
    );
    
    CREATE TABLE AbsoluteNoteNames(
        AbsoluteNoteNameID SMALLINT GENERATED BY DEFAULT AS IDENTITY,
        AbsoluteNoteName VARCHAR(2) UNIQUE NOT NULL,
        AbsoluteNoteID SMALLINT,
        PRIMARY KEY (AbsoluteNoteNameID),
        FOREIGN KEY (AbsoluteNoteID) REFERENCES AbsoluteNotes(AbsoluteNoteID)
    );

    CREATE TABLE NoteDegrees(
        NoteDegreeID SMALLINT GENERATED BY DEFAULT AS IDENTITY,
        NoteDegreeName VARCHAR(5) UNIQUE NOT NULL,
        PRIMARY KEY (NoteDegreeID)
    );

    CREATE TABLE ChordTypes(
        ChordTypeID SMALLINT GENERATED BY DEFAULT AS IDENTITY,
        ChordTypeName VARCHAR(50) UNIQUE NOT NULL,
        ChordTypeShape VARCHAR(50) UNIQUE NOT NULL,
        PRIMARY KEY (ChordTypeID)
    );
    
    CREATE TABLE PopularityLevels(
        PopularityLevelID SMALLINT GENERATED BY DEFAULT AS IDENTITY,
        PopularityLevelName VARCHAR(50) UNIQUE NOT NULL,
        PRIMARY KEY (PopularityLevelID)
    );

    CREATE TABLE Artists(
        ArtistID BIGINT GENERATED BY DEFAULT AS IDENTITY,
        ArtistName VARCHAR(50) NOT NULL,
        PRIMARY KEY (ArtistID)
    );

    CREATE TABLE ModeNoteDegrees(
        ModeID SMALLINT,
        NoteDegreeID SMALLINT,
        PRIMARY KEY (ModeID, NoteDegreeID),
        FOREIGN KEY (ModeID) REFERENCES Modes(ModeID),
        FOREIGN KEY (NoteDegreeID) REFERENCES NoteDegrees(NoteDegreeID)
    );

    CREATE TABLE ChordsByDegree(
        RootDegreeID SMALLINT,
        ChordTypeID SMALLINT,
        PRIMARY KEY (RootDegreeID, ChordTypeID),
        FOREIGN KEY (RootDegreeID) REFERENCES NoteDegrees(NoteDegreeID),
        FOREIGN KEY (ChordTypeID) REFERENCES ChordTypes(ChordTypeID)
    );

    CREATE TABLE ChordNoteDegrees(
        RootDegreeID SMALLINT,
        ChordTypeID SMALLINT,
        NoteDegreeID SMALLINT,
        PRIMARY KEY (RootDegreeID, ChordTypeID, NoteDegreeID),
        FOREIGN KEY (RootDegreeID, ChordTypeID) REFERENCES ChordsByDegree(RootDegreeID, ChordTypeID),
        FOREIGN KEY (NoteDegreeID) REFERENCES NoteDegrees(NoteDegreeID)
    );

    CREATE TABLE SongVersions(
        SongVersionID BIGINT GENERATED BY DEFAULT AS IDENTITY,
        SongVersionName VARCHAR(50) NOT NULL,
        ArtistID BIGINT NOT NULL,
        RootAbsoluteNoteID SMALLINT NOT NULL,
        PopularityLevelID SMALLINT, 
        TimePeriodID INT,
        PRIMARY KEY (SongVersionID),
        FOREIGN KEY (ArtistID) REFERENCES Artists(ArtistID),
        FOREIGN KEY (RootAbsoluteNoteID) REFERENCES AbsoluteNotes(AbsoluteNoteID),
        FOREIGN KEY (PopularityLevelID) REFERENCES PopularityLevels(PopularityLevelID),
        FOREIGN KEY (TimePeriodID) REFERENCES TimePeriods(TimePeriodID)
    );

    CREATE TABLE SongVersionChords(
        SongVersionID BIGINT,
        RootDegreeID SMALLINT,
        ChordTypeID SMALLINT,
        PRIMARY KEY (SongVersionID, RootDegreeID, ChordTypeID),
        FOREIGN KEY (SongVersionID) REFERENCES SongVersions(SongVersionID),
        FOREIGN KEY (RootDegreeID, ChordTypeID) REFERENCES ChordsByDegree(RootDegreeID, ChordTypeID)
    );

    CREATE TABLE SongVersionGenres(
        SongVersionID BIGINT,
        GenreID SMALLINT,
        PRIMARY KEY (SongVersionID, GenreID),
        FOREIGN KEY (SongVersionID) REFERENCES SongVersions(SongVersionID),
        FOREIGN KEY (GenreID) REFERENCES Genres(GenreID)
    );

    CREATE TABLE SongVersionDistances(
        SongVersionID1 BIGINT,
        SongVersionID2 BIGINT,
        Distance NUMERIC,
        PRIMARY KEY (SongversionID1, SongVersionID2),
        FOREIGN KEY (SongVersionID1) REFERENCES SongVersions(SongVersionID),
        FOREIGN KEY (SongVersionID2) REFERENCES SongVersions(SongVersionID),
        CHECK SongVersionID1 < SongVersionID2
    );

    INSERT INTO AbsoluteNotes(AbsoluteNoteID)
    VALUES
        (0), 
        (1),
        (2),
        (3),
        (4),
        (5),
        (6),
        (7),
        (8),
        (9),
        (10),
        (11);    

    INSERT INTO AbsoluteNoteNames(AbsoluteNoteName, AbsoluteNoteID)
    VALUES
        ('C', 0),
        ('C#', 1),
        ('Db', 1),
        ('D', 2),
        ('D#', 3),
        ('Eb', 3),
        ('E', 4),
        ('E#', 5),
        ('F', 5),
        ('F#', 6),
        ('Gb', 6),
        ('G', 7),
        ('G#', 8),
        ('Ab', 8),
        ('A', 9),
        ('A#', 10),
        ('Bb', 10),
        ('B', 11),
        ('Cb', 11);

    INSERT INTO NoteDegrees(NoteDegreeID, NoteDegreeName)
    VALUES
        (0, 'I'),
        (1, 'bII'),
        (2, 'II'),
        (3, 'bIII'),
        (4, 'III'),
        (5, 'IV'),
        (6, '#IV'),
        (7, 'V'),
        (8, 'bVI'),
        (9, 'VI'),
        (10, 'bVII'),
        (11, 'VII');
    
    INSERT INTO ChordTypes(ChordTypeName, ChordTypeShape)
    VALUES
        ('', '0,4,3'),
        ('m', '0,3,4'),
        ('5', '0,7'),
    	('7', '0,4,3,3');
    
    INSERT INTO Modes(ModeID, ModeName)
    VALUES
        (1, 'Ionian'),
        (2, 'Dorian'),
        (3, 'Phrygian'),
        (4, 'Lydian'),
        (5, 'Mixolydian'),
        (6, 'Aeolian'),
        (7, 'Locrian');

    INSERT INTO ModeNoteDegrees(ModeID, NoteDegreeID)
    VALUES
        (1, 0),(1, 2),(1, 4),(1, 5),(1, 7),(1, 9),(1, 11),
        (2, 0),(2, 2),(2, 3),(2, 5),(2, 7),(2, 9),(2, 10),
        (3, 0),(3, 1),(3, 3),(3, 5),(3, 7),(3, 8),(3, 10),
        (4, 0),(4, 2),(4, 4),(4, 6),(4, 7),(4, 9),(4, 11),
        (5, 0),(5, 2),(5, 4),(5, 5),(5, 7),(5, 9),(5, 10),
        (6, 0),(6, 2),(6, 3),(6, 5),(6, 7),(6, 8),(6, 10),
        (7, 0),(7, 1),(7, 3),(7, 5),(7, 6),(7, 8),(7, 10);
    """

    # Distance table

    try:
        conn = psycopg2.connect(login_info)
        conn.set_isolation_level(0)
        cur = conn.cursor()
        cur.execute(SQL)
    except:
        print("I am unable to connect to the database")

def mode_input(mode_name: str, mode_notes: list) -> None:
    pass
    # '''
    # INSERT INTO Modes(ModeName)
    # '''

if __name__=='__main__':
    main()
